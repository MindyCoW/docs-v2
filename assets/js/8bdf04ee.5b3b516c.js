"use strict";(self.webpackChunkcow_docs=self.webpackChunkcow_docs||[]).push([[6458],{54893:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var s=n(85893),i=n(11151);const a={},o="Slippage accounting",r={id:"solvers/in-depth-solver-specification/slippage-accounting",title:"Slippage accounting",description:"Solver Slippage Accounting",source:"@site/docs/solvers/in-depth-solver-specification/slippage-accounting.md",sourceDirName:"solvers/in-depth-solver-specification",slug:"/solvers/in-depth-solver-specification/slippage-accounting",permalink:"/docs-v2/docs/solvers/in-depth-solver-specification/slippage-accounting",draft:!1,unlisted:!1,editUrl:"https://github.com/cowprotocol/docs/tree/main/docs/solvers/in-depth-solver-specification/slippage-accounting.md",tags:[],version:"current",frontMatter:{}},c={},l=[{value:"Solver Slippage Accounting",id:"solver-slippage-accounting",level:2},{value:"1. Batch-wise Token Imbalance",id:"1-batch-wise-token-imbalance",level:3},{value:"Transfer Type Classification",id:"transfer-type-classification",level:4},{value:"Phantom Transfers (aka Internalized Token Imbalance)",id:"phantom-transfers-aka-internalized-token-imbalance",level:4},{value:"2. Evaluation in ETH (aka Token Prices)",id:"2-evaluation-in-eth-aka-token-prices",level:3}];function d(e){const t=Object.assign({h1:"h1",h2:"h2",p:"p",a:"a",h3:"h3",code:"code",h4:"h4",ul:"ul",li:"li",em:"em",strong:"strong"},(0,i.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"slippage-accounting",children:"Slippage accounting"}),"\n",(0,s.jsx)(t.h2,{id:"solver-slippage-accounting",children:"Solver Slippage Accounting"}),"\n",(0,s.jsxs)(t.p,{children:["Slippage accounting is performed on a per settlement/transaction basis according to the following two primary components. The SQL source code can be found on ",(0,s.jsx)(t.a,{href:"https://github.com/cowprotocol/solver-rewards/blob/main/queries/dune_v2/period_slippage.sql",children:"GitHub"})," or ",(0,s.jsx)(t.a,{href:"https://dune.com/queries/2421375",children:"Dune Analytics"})]}),"\n",(0,s.jsx)(t.h3,{id:"1-batch-wise-token-imbalance",children:"1. Batch-wise Token Imbalance"}),"\n",(0,s.jsxs)(t.p,{children:["The token balance sheet represents a classified account of all incoming and outgoing token transfers relative to the settlement contract. Classification categories are ",(0,s.jsx)(t.code,{children:"USER_{IN/OUT}"}),", ",(0,s.jsx)(t.code,{children:"AMM_{IN/OUT}"})," and ",(0,s.jsx)(t.code,{children:"PHANTOM_TRANSFER"})]}),"\n",(0,s.jsx)(t.h4,{id:"transfer-type-classification",children:"Transfer Type Classification"}),"\n",(0,s.jsxs)(t.p,{children:["In all cases ",(0,s.jsx)(t.code,{children:"IN"})," represents settlement contract as ",(0,s.jsx)(t.code,{children:"recipient"})," and ",(0,s.jsx)(t.code,{children:"OUT"})," as ",(0,s.jsx)(t.code,{children:"sender"}),"!"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"USER_{IN/OUT}"})," transfers are those emitted by the Settlement contract's Trade Event (with ",(0,s.jsx)(t.code,{children:"USER_IN"})," adjusted for fees)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"AMM_{IN/OUT}"})," classification is assigned to all on-chain transfers that are NOT user transfers"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"PHANTOM_TRANSFER"})," represents token transfers associated with ",(0,s.jsx)(t.em,{children:"internalized buffer trades"}),'. In brief, these are transfers related to AMM interactions that were "skipped" for the purpose of gas optimization in favour of using the settlement contract\'s internal holdings. The process for including this "off-chain" data is rather involved, so we dedicate an entire section to it below.']}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Note that ",(0,s.jsx)(t.code,{children:"AMM_IN/OUT"})," also captures ",(0,s.jsx)(t.code,{children:"WETH"})," token (un)wraps."]}),"\n",(0,s.jsx)(t.h4,{id:"phantom-transfers-aka-internalized-token-imbalance",children:"Phantom Transfers (aka Internalized Token Imbalance)"}),"\n",(0,s.jsxs)(t.p,{children:['As mentioned above, as a form of gas optimization, solvers may indicate whether certain AMM interactions may be "internalized" if the settlement contract has sufficient balance and would be willing to facilitate the trade with their own funds. Solvers are expected to provide the ',(0,s.jsx)(t.code,{children:"complete"})," and ",(0,s.jsx)(t.code,{children:"reduced"})," ",(0,s.jsx)(t.em,{children:"call-data"})," which serves as proof that there was indeed a liquidity source on the competition block that would have filled the trade with the quoted amounts. Internal token imbalances are computed by simulating the transactions with both the ",(0,s.jsx)(t.code,{children:"complete"})," and ",(0,s.jsx)(t.code,{children:"reduced"})," call-data, parsing the transfers and take the difference. This difference represents a ",(0,s.jsx)(t.strong,{children:"very close approximation"}),' of the "phantom" transfers that would have happened if the settlement had not been internalized.']}),"\n",(0,s.jsxs)(t.p,{children:["Note the use of the term ",(0,s.jsx)(t.em,{children:"approximation"})," in this context means that the simulations happened on the ",(0,s.jsx)(t.strong,{children:"competition block"})," which is strictly earlier than the ",(0,s.jsx)(t.strong,{children:"settlement block"}),' where the transaction was mined. It may happen that the state of skipped liquidity sources changes between these blocks, but this process fairly and accurately captures the solver\'s "intent" (anything else is essentially slippage anyway). This process is deemed to be deterministic, upto potential disagreement between transaction simulators.']}),"\n",(0,s.jsxs)(t.p,{children:["Please find the source code for internal imbalances at ",(0,s.jsx)(t.a,{href:"https://github.com/cowprotocol/solver-rewards/tree/main/internal%5C_transfers",children:"https://github.com/cowprotocol/solver-rewards/tree/main/internal\\_transfers"})]}),"\n",(0,s.jsx)(t.h3,{id:"2-evaluation-in-eth-aka-token-prices",children:"2. Evaluation in ETH (aka Token Prices)"}),"\n",(0,s.jsxs)(t.p,{children:["Token prices are taken as the ",(0,s.jsx)(t.em,{children:"hourly mean"})," over Dune's ",(0,s.jsx)(t.code,{children:"prices.usd"}),' table in combination with the "intrinsic" token prices provided in settlements. SQL code for price table is ',(0,s.jsx)(t.a,{href:"https://github.com/cowprotocol/solver-rewards/blob/dd2cb170cf6c214b8c2edf1d82eec333d2fa35a1/queries/dune_v2/period_slippage.sql#L258-L324",children:"here"})]})]})}const h=function(e={}){const{wrapper:t}=Object.assign({},(0,i.ah)(),e.components);return t?(0,s.jsx)(t,Object.assign({},e,{children:(0,s.jsx)(d,e)})):d(e)}},11151:(e,t,n)=>{n.d(t,{Zo:()=>r,ah:()=>a});var s=n(67294);const i=s.createContext({});function a(e){const t=s.useContext(i);return s.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const o={};function r({components:e,children:t,disableParentContext:n}){let r;return r=n?"function"==typeof e?e({}):e||o:a(e),s.createElement(i.Provider,{value:r},t)}}}]);